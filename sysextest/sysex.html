<html>
<head>
<script>
const nuevi_vendor = [ 0x00, 0x3e, 0x5a ];

navigator.requestMIDIAccess({ sysex: true })
    .then(onMIDISuccess, onMIDIFailure);

function onMIDISuccess(midiAccess) {
    console.log(midiAccess);

    var inputs = midiAccess.inputs;
    var outputs = midiAccess.outputs;
    console.log(inputs);
    //inputs.forEach(bralla);


    for (var input of midiAccess.inputs.values())Â {
    	bralla(input);
        input.onmidimessage = getMIDIMessage;
    }
}

function bralla(midiinput) {

	var dd = document.getElementById("mididevice");
	

	var opt = document.createElement("option");
	opt.text = midiinput.name;
	opt.id = midiinput.id;
	dd.add(opt, dd[-1]);

	console.log(midiinput.name);
}

//Silly comparision function for arrays
function comparevendor(v1, v2) {
	if(v1.length != v2.length) return false;

	for(var i=0; i<v1.length; ++i)
		if(v1[i] != v2[i]) return false;

	return true;
}

function getMIDIMessage(midiMessage) {

	var midiraw = midiMessage.data;

	if(midiraw.length<2) return; //Some devices seem to spit out "empty stuff" on occasion. Ignore these.

	var midi_command = midiraw[0];

	switch(midi_command) {
		case 0xF0: //SysEx
			var vendor = midiraw[1];
			if(vendor==0x00) {
				vendor = midiraw.subarray(1,4);
			}
			if(!comparevendor(vendor, nuevi_vendor)) {
				console.log("Unknown vendor: " + vendor);
				return;

			}

			var header = new TextDecoder("utf-8").decode(midiraw.subarray(4,12));
			if(header!="NuEVIc00") {
				console.log("Unknown header: " + header);
				return;
			}

			config = midiraw.subarray(12, -1); //Skip last byte, sysex terminator 0xF7
			if(config.length != 88) {
				console.log("Bad config length: " + config.length);
				return;
			}

			var parsedconfig = [];

			for(var i=0; i<config.length/2; i++) {
				var msb = config[i*2];     //MIDI is supposed to be big-endian
				var lsb = config[i*2+1];
				var word = msb << 7 | lsb; //Convert from 7+7 to 16 bits
				parsedconfig.push(word);
			}
			console.log("Successfully grabbed NuEVI config: ");
			console.log(parsedconfig);
		
			break;

		default:
			console.log("Unhandled midi command: " + midiraw);
			break;
	}

}

function onMIDIFailure() {
    console.log('Could not access your MIDI devices.');
}
</script>
</head>
<body>
Hej.
<select size="1" id="mididevice" />
</body>
</html>